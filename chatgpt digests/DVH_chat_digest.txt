DVH chat digest placeholder.

DVH Uncertainty & Plotting — Chat Digest

1) Key concepts & decisions
- Interpolation policy:
  * Lines (for visualization): linear interpolation of (% volume) vs dose on a dense x-grid (smooth for paper).
  * Metrics/ticks/markers (for truth): step semantics on the ORIGINAL cumulative curves (discrete voxel logic).
    - D_x%: invert the cumulative step y(d) → smallest dose d with y(d) ≤ x%.
    - V_y%: read y(thr) at thr = (y/100)*ref_dose via the step value at the smallest dose ≥ thr.
  Result: smoothed lines, but Dx/Vy ticks & table markers land correctly.

- Uncertainty bands (two senses):
  * Vertical (Vy-consistent): percentiles across trials at fixed dose. Color wash (springgreen 5–25 & 75–95, dodgerblue 25–75) with dotted black outlines.
  * Horizontal (Dx-consistent): percentiles across trials at fixed % volume (invert per trial first). Draw as thin black (25–75) and gray dashed (5–95) isolines (no wash).
  * bands_mode: "vertical", "horizontal", or "both".

- Markers & ticks (paper-friendly):
  * Ticks: small black ticks computed from ORIGINAL step curves (+ light-gray guides).
    Controls: show_ticks, show_dx_ticks, show_vy_ticks.
  * Markers (from your table DF): two shapes, all black.
    Circles = Dx (x=stat value in Gy, y=X%). Squares = Vy (x=(Y/100)*ref_dose, y=stat %). Nominal marker = red “x”.
    Controls: show_markers, show_dx_markers, show_vy_markers.

- Random trials (diagnostic):
  * Up to num_rand_trials_to_show dashed black trials (1..k, nominal=0 is solid red).
  * trial_annotation_style='number' restores the gray textbox listing per-trial shifts (X,Y,Z) and |d|.

- What previously caused misalignment (now fixed):
  * Mixing linear interpolation (lines) with linearized metric lookups (should be step).
  * Inversion clamp directions wrong → “leftward hooks” at low % volume.
  * Attempting np.interp on 2D matrices.
  * statsmodels return type differences (.to_numpy() not always available).

2) Latest core functions (high level)

A) build_cumulative_dvh_by_mc_trial_number_df(df)
- Sort doses per (patient, bx, trial); unique values + counts → right cumulative → % volume.
- Returns: Patient ID, Bx ID, Bx index, Simulated bool/type, Percent volume, Dose (Gy), MC trial.

B) compute_dvh_metrics_per_trial_vectorized(...)
- D_x% via groupby.quantile(q=1−X/100, interpolation='higher') for step semantics.
- V_y% as fraction of voxels ≥ threshold (Y/100)*ref_dose.
- One row per (Patient ID, Bx index, MC trial) + metadata.

C) production_plot_cumulative_or_differential_DVH_kernel_quantile_regression_NEW_v4_5(...)
- bands_mode in {"vertical","horizontal","both"}.
- show_median_line, show_mean_line.
- Global toggles: show_ticks/show_markers; finer: show_dx_ticks/show_vy_ticks/show_dx_markers/show_vy_markers.
- dx_list, vy_list, ref_dose_gy.
- dvh_metrics_df overlay with overlay_metrics_stats=('Nominal','Q05','Q25','Q50','Q75','Q95').
- Styling: circles=Dx, squares=Vy (black), nominal marker red “x”.
- Horizontal envelopes = inversion of ORIGINAL step curves per trial; vertical wash = percentiles on dense grid.

D) Deltas & CSV
- compute_biopsy_nominal_deltas_with_abs(...) → adds both signed and absolute deltas.
- save_delta_boxplot_summary_csv_with_absolute(...) → writes two rows per delta (Δ and |Δ|) with n, mean, std, sem, min, q05, q25, q50, q75, q95, max, iqr.

E) Δ vs gradient join
- build_delta_vs_gradient_long_df(...) merges on ['Patient ID','Bx index','Voxel index'] to retain biopsy identity and enable correlation plots/stats.

F) OLS helper (statsmodels safe)
- Guard for pandas/numpy outputs; compute slope, intercept, CI, r, r², p with (optionally) HC3 robust SE.

3) Tables updated (LaTeX)
- Per-biopsy DVH summary (Patient 184, Bx1 vs Bx2): recomputed from Cohort_DVH_metrics_stats_per_biopsy.csv.
  Dx in Gy; Vy in % (thresholds relative to 13.5 Gy).
- Cohort-level DVH metrics (sideways + condensed): from dvh_metrics_statistics_all_patients.csv; condensed also includes V200%.
- Deltas summary with |Δ| rows: from dose_deltas_boxplot_summary.csv and dose_gradient_deltas_boxplot_summary.csv.

4) Common errors & quick fixes
- np.interp “object too deep”: invert per trial; stack after.
- Leftward bend at low y: clamp invert with left=xt.max(), right=xt.min().
- Ticks/markers off-line: compute from ORIGINAL step curves; lines are only for aesthetics.
- statsmodels .conf_int(): use .to_numpy() if present else np.asarray(...).

5) Paper guidance
- Main figures: vertical wash + nominal & median; hide dashed random trials and markers/ticks for clean look.
- If Dx envelopes shown: thin horizontal-sense lines only, no wash.
- Results/Discussion: focus on the two envelope notions, concordance of table markers with ticks, and Δ behavior vs ‖∇D‖.
